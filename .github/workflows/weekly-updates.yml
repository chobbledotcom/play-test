---
name: 'Weekly: Update Annotations & Attributions'
on:
  schedule:
    - cron: 0 2 * * 1  # Every Monday at 2am UTC
  workflow_dispatch:  # Allow manual triggering
permissions:
  contents: write
  pull-requests: write
jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0  # Full history for better git operations
      - name: Setup environment
        uses: ./.github/actions/setup-environment
      - name: Install CI annotation gems
        run: |
          bundle config unset --local without
          bundle config set --local with 'ci_annotations'
          bundle install
      - name: Git setup
        uses: ./.github/actions/git-setup
      - name: Create or switch to update branch
        run: |
          git checkout -B automated/annotations-attributions
      - name: Update model annotations
        run: bundle exec annotaterb models
        continue-on-error: true
      - name: Update route annotations
        run: bundle exec annotaterb routes
        continue-on-error: true
      - name: Generate third-party attributions
        run: bundle exec rake attributions:generate
        continue-on-error: true
      - name: Commit, push, and create PR
        uses: ./.github/actions/create-automation-pr
        with:
          type: annotations
          branch-name: automated/annotations-attributions
          commit-message: |
            Update annotations and attributions
            
            - Updated model annotations based on current schema
            - Updated route annotations based on current routes
            - Regenerated third-party attributions from Gemfile
            
            [Automated weekly update]
          github-token: ${{ secrets.GITHUB_TOKEN }}
