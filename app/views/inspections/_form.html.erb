<%
  inspection = local_assigns.fetch(:inspection)
  # Check if there are incomplete fields on the inspection tab
  has_incomplete_fields = inspection.inspection_tab_incomplete_fields.any?
  submit_key = has_incomplete_fields ? "submit_continue" : "submit"
%>
<%= render 'chobble_forms/form_context',
  model: inspection,
  i18n_base: 'forms.inspection',
  submit_key: submit_key do |form| %>
  <%= render 'chobble_forms/fieldset', legend_key: 'current_unit' do %>
    <% if inspection.unit.present? %>
      <%= render 'shared/unit_details_display', unit: inspection.unit %>
      <%= link_to t('inspections.buttons.change_unit'),
        select_unit_inspection_path(inspection) %>
      <br>
    <% else %>
      <p><%= t('inspections.messages.no_unit') %></p>
      <%= link_to t('inspections.buttons.select_unit'),
        select_unit_inspection_path(inspection) %>
      <br><br>
      <%= link_to t('inspections.buttons.create_unit_from_inspection'),
        new_unit_from_inspection_path(inspection) %>
    <% end %>
  <% end %>

  <% unless inspection.new_record? %>
    <%= render 'chobble_forms/fieldset', legend_key: 'public_information' do %>
      <%= render 'chobble_forms/display_field', field: :id %>
      <div>
        <%= link_to t('inspections.buttons.download_pdf'),
          inspection_path(inspection, format: :pdf),
          target: '_blank' %> /
        <%= link_to t('inspections.buttons.download_qr_code'),
          inspection_path(inspection, format: :png),
          download: "inspection-#{inspection.id}-qr.png" %>
      </div>
    <% end %>
  <% end %>

  <%= render 'chobble_forms/fieldset', legend_key: 'inspection_details' do %>
    <%= render 'chobble_forms/date_field', field: :inspection_date %>
    <%= render 'chobble_forms/text_field', field: :operator %>

    <div class="calculated-field">
      <label><%= t('inspections.fields.reinspection_date') %></label>
      <p class="calculated-value">
        <%= inspection.reinspection_date&.strftime("%-d %B %Y") || t('inspections.fields.calculated_after_save') %>
        <small class="help-text"><%= t('inspections.fields.reinspection_date_help') %></small>
      </p>
    </div>
  <% end %>

  <%= render 'chobble_forms/fields', model: inspection %>

<% end %>
