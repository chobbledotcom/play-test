<%= render 'shared/page_header', title: t('users.titles.settings') %>

<%= render 'chobble_forms/form_context', model: @user, i18n_base: 'forms.user_settings',
  url: update_settings_user_path(@user),
  method: :patch do |form| %>

  <%= render 'chobble_forms/fieldset', legend_key: 'contact_details' do %>
    <% if @user.has_company? %>
      <%= render 'chobble_forms/display_field', field: :name %>
      <%= render 'chobble_forms/display_field', field: :phone %>
      <%= render 'chobble_forms/display_field', field: :address %>
      <%= render 'chobble_forms/display_field', field: :country %>
      <%= render 'chobble_forms/display_field', field: :postal_code %>
      <p><%= t('users.messages.inherited_from_company') %></p>
    <% else %>
      <%= render 'chobble_forms/display_field', field: :name %>
      <%= render 'chobble_forms/text_field', field: :phone %>
      <%= render 'chobble_forms/text_area', field: :address %>
      <%= render 'chobble_forms/text_field', field: :country %>
      <%= render 'chobble_forms/text_field', field: :postal_code %>
    <% end %>
  <% end %>

  <%= render 'chobble_forms/fieldset', legend_key: 'preferences' do %>
    <% unless theme_selector_disabled? %>
      <%= render 'chobble_forms/select',
        field: :theme,
        options: options_for_select([
          [t('users.options.theme_light'), "light"],
          [t('users.options.theme_default'), "default"],
          [t('users.options.theme_dark'), "dark"]
        ], @user.theme) %>
    <% end %>

    <%= turbo_frame_tag "user_logo_field" do %>
      <%= render 'chobble_forms/file_field', field: :logo, accept: "image/*" %>
    <% end %>

    <%= turbo_frame_tag "user_signature_field" do %>
      <%= render 'chobble_forms/file_field', field: :signature, accept: "image/*" %>
    <% end %>
  <% end %>
<% end %>

<div class="margins center">
  <%= link_to change_password_user_path(current_user) do %>
    <strong>Change Password</strong>
  <% end %>
</div>

<details>
  <summary><%= t('users.sessions.title') %></summary>
  
  <div class="margins">
    <%= link_to t('users.sessions.logout_everywhere_else'), 
        logout_everywhere_else_user_path(current_user),
        data: { 
          turbo_method: :delete,
          turbo_confirm: t('users.sessions.logout_everywhere_confirm')
        } %>
  </div>

  <table>
    <thead>
      <tr>
        <th><%= t('users.sessions.first_active') %></th>
        <th><%= t('users.sessions.last_active') %></th>
        <th><%= t('users.sessions.ip_address') %></th>
      </tr>
    </thead>
    <tbody>
      <% current_user.user_sessions.active.recent.each do |user_session| %>
        <tr>
          <td><%= user_session.created_at.strftime("%Y-%m-%d %H:%M") %></td>
          <td>
            <%= user_session.last_active_at.strftime("%Y-%m-%d %H:%M") %>
            <% if session[:session_token] == user_session.session_token %>
              <strong>(<%= t('users.sessions.current') %>)</strong>
            <% end %>
          </td>
          <td><%= user_session.ip_address || t('users.sessions.unknown') %></td>
        </tr>
      <% end %>
    </tbody>
  </table>
</details>
