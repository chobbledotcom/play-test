#!/bin/bash -e

# Enable jemalloc for reduced memory usage and latency.
if [ -z "${LD_PRELOAD+x}" ] && [ -f /usr/lib/*/libjemalloc.so.2 ]; then
  export LD_PRELOAD="$(echo /usr/lib/*/libjemalloc.so.2)"
fi

# If running the rails server then create or migrate existing database
if [ "${1}" == "./bin/rails" ] && [ "${2}" == "server" ]; then
  # Restore databases from S3 using Litestream if enabled and databases don't exist
  if [ "${LITESTREAM_ENABLED}" == "true" ]; then
    echo "Litestream is enabled. Checking for databases to restore..."

    # Restore production database if it doesn't exist
    if [ ! -f "storage/production.sqlite3" ]; then
      echo "Production database not found locally. Attempting to restore from S3..."
      bundle exec litestream restore -config config/litestream.yml storage/production.sqlite3 || {
        echo "No backup found in S3 or restore failed. Will create new database."
      }
    else
      echo "Production database already exists locally."
    fi
  fi

  ./bin/rails db:prepare
  
  echo "Setting up cron jobs with whenever..."
  # Generate crontab file for supercronic
  bundle exec whenever > /tmp/crontab
  
  echo "Starting supercronic in background..."
  supercronic /tmp/crontab &

  echo "Starting Solid Queue worker in background..."
  ./bin/jobs &
fi

exec "${@}"
