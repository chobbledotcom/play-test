#!/usr/bin/env bash
set -euo pipefail

# Script to install actionlint for GitHub Actions workflow validation

ACTIONLINT_VERSION="1.7.7"
INSTALL_DIR="bin"
ACTIONLINT_PATH="${INSTALL_DIR}/actionlint"

# Detect OS and architecture
OS=$(uname -s | tr '[:upper:]' '[:lower:]')
ARCH=$(uname -m)

# Map architecture names
case "$ARCH" in
  x86_64) ARCH="amd64" ;;
  aarch64|arm64) ARCH="arm64" ;;
  armv7l) ARCH="armv7" ;;
  *) echo "Unsupported architecture: $ARCH"; exit 1 ;;
esac

# Construct download URL
DOWNLOAD_URL="https://github.com/rhysd/actionlint/releases/download/v${ACTIONLINT_VERSION}/actionlint_${ACTIONLINT_VERSION}_${OS}_${ARCH}.tar.gz"

echo "Installing actionlint v${ACTIONLINT_VERSION}..."
echo "Downloading from: $DOWNLOAD_URL"

# Create temp directory
TEMP_DIR=$(mktemp -d)
trap "rm -rf $TEMP_DIR" EXIT

# Download and extract
curl -L -o "$TEMP_DIR/actionlint.tar.gz" "$DOWNLOAD_URL"
tar -xzf "$TEMP_DIR/actionlint.tar.gz" -C "$TEMP_DIR"

# Create bin directory if it doesn't exist
mkdir -p "$INSTALL_DIR"

# Install actionlint
mv "$TEMP_DIR/actionlint" "$ACTIONLINT_PATH"
chmod +x "$ACTIONLINT_PATH"

echo "✓ actionlint installed successfully at $ACTIONLINT_PATH"
echo "✓ Version: $($ACTIONLINT_PATH -version)"